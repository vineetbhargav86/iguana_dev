// placeholder of API peers response
var response = {  
   "peers":[  
      {  
         "ipaddr":"127.0.0.1",
         "protover":60013,
         "relay":1,
         "height":854849,
         "rank":0,
         "usock":4,
         "ready":1449777119,
         "msgcounts":{  
            "version":1,
            "verack":1,
            "getaddr":0,
            "addr":2,
            "inv":0,
            "getdata":0,
            "notfound":0,
            "getblocks":0,
            "getheaders":0,
            "headers":0,
            "tx":0,
            "block":0,
            "mempool":0,
            "ping":0,
            "pong":0,
            "reject":0,
            "filterload":0,
            "filteradd":0,
            "filterclear":0,
            "merkleblock":0,
            "alert":0
         }
      },
      {  
         "ipaddr":"234.0.0.1",
         "protover":50013,
         "relay":1,
         "height":584849,
         "rank":1,
         "usock":4,
         "ready":1449777119,
         "msgcounts":{  
            "version":1,
            "verack":1,
            "getaddr":0,
            "addr":2,
            "inv":0,
            "getdata":0,
            "notfound":0,
            "getblocks":0,
            "getheaders":0,
            "headers":0,
            "tx":0,
            "block":0,
            "mempool":0,
            "ping":0,
            "pong":0,
            "reject":0,
            "filterload":0,
            "filteradd":0,
            "filterclear":0,
            "merkleblock":0,
            "alert":0
         }
      },
      {  
         "ipaddr":"345.0.0.1",
         "protover":62013,
         "relay":1,
         "height":354849,
         "rank":1,
         "usock":4,
         "ready":1449777119,
         "msgcounts":{  
            "version":1,
            "verack":1,
            "getaddr":0,
            "addr":2,
            "inv":0,
            "getdata":0,
            "notfound":0,
            "getblocks":0,
            "getheaders":0,
            "headers":0,
            "tx":0,
            "block":0,
            "mempool":0,
            "ping":0,
            "pong":0,
            "reject":0,
            "filterload":0,
            "filteradd":0,
            "filterclear":0,
            "merkleblock":0,
            "alert":0
         }
      },
      {  
         "ipaddr":"567.0.0.1",
         "protover":30013,
         "relay":1,
         "height":454849,
         "rank":0,
         "usock":4,
         "ready":1449777119,
         "msgcounts":{  
            "version":1,
            "verack":1,
            "getaddr":0,
            "addr":2,
            "inv":0,
            "getdata":0,
            "notfound":0,
            "getblocks":0,
            "getheaders":0,
            "headers":0,
            "tx":0,
            "block":0,
            "mempool":0,
            "ping":0,
            "pong":0,
            "reject":0,
            "filterload":0,
            "filteradd":0,
            "filterclear":0,
            "merkleblock":0,
            "alert":0
         }
      },
      {  
         "ipaddr":"321.0.0.1",
         "protover":55013,
         "relay":1,
         "height":444849,
         "rank":2,
         "usock":4,
         "ready":1449777119,
         "msgcounts":{  
            "version":1,
            "verack":1,
            "getaddr":0,
            "addr":2,
            "inv":0,
            "getdata":0,
            "notfound":0,
            "getblocks":0,
            "getheaders":0,
            "headers":0,
            "tx":0,
            "block":0,
            "mempool":0,
            "ping":0,
            "pong":0,
            "reject":0,
            "filterload":0,
            "filteradd":0,
            "filterclear":0,
            "merkleblock":0,
            "alert":0
         }
      },
      {  
         "ipaddr":"764.0.0.1",
         "protover":60013,
         "relay":1,
         "height":134849,
         "rank":2,
         "usock":4,
         "ready":3249777119,
         "msgcounts":{  
            "version":1,
            "verack":1,
            "getaddr":0,
            "addr":2,
            "inv":0,
            "getdata":0,
            "notfound":0,
            "getblocks":0,
            "getheaders":0,
            "headers":0,
            "tx":0,
            "block":0,
            "mempool":0,
            "ping":0,
            "pong":0,
            "reject":0,
            "filterload":0,
            "filteradd":0,
            "filterclear":0,
            "merkleblock":0,
            "alert":0
         }
      },
      {  
         "ipaddr":"327.0.0.1",
         "protover":60013,
         "relay":1,
         "height":854849,
         "rank":3,
         "usock":4,
         "ready":1449777119,
         "msgcounts":{  
            "version":1,
            "verack":1,
            "getaddr":0,
            "addr":2,
            "inv":0,
            "getdata":0,
            "notfound":0,
            "getblocks":0,
            "getheaders":0,
            "headers":0,
            "tx":0,
            "block":0,
            "mempool":0,
            "ping":0,
            "pong":0,
            "reject":0,
            "filterload":0,
            "filteradd":0,
            "filterclear":0,
            "merkleblock":0,
            "alert":0
         }
      },
      {  
         "ipaddr":"765.0.0.1",
         "protover":60013,
         "relay":1,
         "height":854849,
         "rank":0,
         "usock":4,
         "ready":1449777119,
         "msgcounts":{  
            "version":1,
            "verack":1,
            "getaddr":0,
            "addr":2,
            "inv":0,
            "getdata":0,
            "notfound":0,
            "getblocks":0,
            "getheaders":0,
            "headers":0,
            "tx":0,
            "block":0,
            "mempool":0,
            "ping":0,
            "pong":0,
            "reject":0,
            "filterload":0,
            "filteradd":0,
            "filterclear":0,
            "merkleblock":0,
            "alert":0
         }
      },
      {  
         "ipaddr":"255.0.0.1",
         "protover":60013,
         "relay":1,
         "height":854849,
         "rank":2,
         "usock":4,
         "ready":1449777119,
         "msgcounts":{  
            "version":1,
            "verack":1,
            "getaddr":0,
            "addr":2,
            "inv":0,
            "getdata":0,
            "notfound":0,
            "getblocks":0,
            "getheaders":0,
            "headers":0,
            "tx":0,
            "block":0,
            "mempool":0,
            "ping":0,
            "pong":0,
            "reject":0,
            "filterload":0,
            "filteradd":0,
            "filterclear":0,
            "merkleblock":0,
            "alert":0
         }
      }
   ],
   "maxpeers":32,
   "coin":"BTCD",
   "tag":"12697016274367621769"
};


var peerlist = (function(peerlist, $, undefined) {

	var coin_types = ['BTC', 'BTCD'];
	var addRow = function( table, object, fav ) {
		table.row.add([
			function() {
				if ( object.name ) {
					return object.name;
				} else {
					return '';
				}
			},
			object.ipaddr,
			object.cointype,
			object.height,
			object.rank,
			function() {
				if ( !fav ) {
					var to_return = '<button class="btn btn-default btn-disconnect">Disconnect</button>';
					to_return += '<button class="btn btn-success btn-fave pull-right">Add Favorite</button>';
				} else if ( fav ) {
					var to_return = '<button class="btn btn-default btn-connect">Connect</button>';
					to_return += '<button class="btn btn-warning btn-unfave pull-right">Remove Favorite</button>';
				}
				to_return += '<span hidden class="obj-keeper">' + JSON.stringify( object ) + '</span>';
				return to_return;
			}
		]).draw( false );
	};

	$(document).ready(function() {
		// initializing peers table
		var peer_table = $('#peerlist_tab').DataTable( {
			"columns": [
				{ },
				{ },
				{ },
				{ },
				{ },
				{
					"orderable":false,
					"width":"23%"
				}
			],
			"lengthChange":false,
			"pageLength":25,
			"autoWidth":false,
			"language": {
				"emptyTable":"Can't get peers list =("
			}
		});
		// adding rows to table
		var coin = response.coin;
		for ( i=0; i<response.peers.length; i++ ) {
			response.peers[i].cointype = coin;
			addRow( peer_table, response.peers[i] );
		}


		// initializing favorite peers table
		if ( localStorage['fav_peers'] ) {
			fav_peers = JSON.parse( localStorage['fav_peers'] );
			console.log('Loaded ' + fav_peers.length + ' favorite peers');
		} else {
			fav_peers = [];
			console.log('No favorite peers found');
		}
		
		var fav_peer_table = $('#fav_peerlist_tab').DataTable( {
			"language": {
				"emptyTable":"You have no favorite peers"
			},
			"lengthChange":false,
			"pageLength":25,
			"autoWidth":false,
			"columns": [
				{ },
				{ },
				{ },
				{ },
				{ },
				{
					"orderable":false,
					"width":"23%"
				}
			]
		});
		for ( i=0; i<fav_peers.length; i++ ) {
			addRow( fav_peer_table, fav_peers[i], fav = true );
		}
		// handling "add favorite" button
		$(document).on('click', '.btn-fave', function(event) {
			// getting raw object
			var data = $(event.target).parents('tr').find('.obj-keeper').text();
			var object = JSON.parse(data);
			// adding it favorite peers array
			fav_peers.push( object );
			addRow( fav_peer_table, object, fav = true );
			// storing array in local storage
			localStorage['fav_peers'] = JSON.stringify(fav_peers);
		});
		// handling "remove from favorite" button
		// working on it
		/*
		$(document).on('click', '.btn-unfave', function(event) {
			// getting raw object
			var data = $(event.target).parents('tr').find('.obj-keeper').text();
			var object = JSON.parse(data);
			for (i=0; i<fav_peers.length; i++ ) {

			}
			$(event.target).parents('tr').revome();
		});
		*/
	});
    return peerlist;
}(peerlist || {}, jQuery));
